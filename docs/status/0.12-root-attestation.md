# 0.12 Status: Root Role Attestation

Tracking checklist for implementing `docs/design/0.12-root-attestation.md`.

## Metadata

- [ ] `Status owner assigned`
- [ ] `Target release confirmed as 0.12`
- [ ] `Implementation branch created`

## Core Architecture

- [ ] Add `IssueRoleAttestation` to `RootCapability`.
- [ ] Add `IssueRoleAttestation` request/response wiring in root dispatch path.
- [ ] Ensure attestation issuance is capability-gated by policy.
- [ ] Ensure 0.11 capability dispatcher behavior remains unchanged.

## Domain Separation

- [ ] Define attestation signing domain separate from delegation domain.
- [ ] Ensure attestation key material is distinct from delegation ECDSA key material.
- [ ] Ensure attestation keys cannot sign delegation tokens.
- [ ] Ensure delegation keys cannot sign attestations.

## Attestation Model

- [ ] Add `RoleAttestation` payload (`subject`, `role`, `subnet_id`, `audience`, `issued_at`, `expires_at`, `epoch`).
- [ ] Add `SignedRoleAttestation` envelope (`payload`, `signature`, `key_id`).
- [ ] Ensure `issued_at`/`expires_at` are root-generated and time-source consistent.
- [ ] Enforce `0 < (expires_at - issued_at) <= MAX_ATTESTATION_TTL_SECONDS`.
- [ ] Add configuration for `MAX_ATTESTATION_TTL_SECONDS`.

## Issuance Policy

- [ ] Validate structural eligibility before issuance.
- [ ] Enforce role-specific issuance constraints.
- [ ] Enforce audience requirement for mutating/inter-service auth use cases.
- [ ] Ensure issuance path cannot imply execution authority.

## Verification Rules

- [ ] Resolve verification key by `key_id`.
- [ ] Validate attestation signature before authorization.
- [ ] Enforce `payload.subject == ic::caller()` before authorization decisions.
- [ ] Enforce expiry check (`expires_at >= now`).
- [ ] If `audience` is present, enforce `audience == ic::id()`.
- [ ] If `subnet_id` is present, enforce verifier subnet equality.
- [ ] Enforce `payload.epoch >= min_accepted_epoch`.
- [ ] Ensure verifier fails closed on all verification errors.

## Key Distribution and Cache

- [ ] Expose read-only root endpoint `attestation_key_set() -> AttestationKeySet`.
- [ ] Include `key_id`, `public_key`, status (`current`/`previous`), validity metadata.
- [ ] Treat root canister principal as trust anchor for attestation keys.
- [ ] Add certified-data support for key-set endpoint (or document gap if deferred).
- [ ] Fetch key set at startup/post-upgrade before mutating attestation auth paths.
- [ ] Refresh key set periodically.
- [ ] On unknown `key_id`, trigger immediate refresh and retry once.
- [ ] Enforce one refresh attempt max per request (no recursion).
- [ ] Ensure key-cache replacement is atomic.
- [ ] Ensure verifier fails closed when key resolution fails.

## Revocation and Rotation

- [ ] Support revocation by TTL expiration.
- [ ] Support revocation by `min_accepted_epoch` bump per role.
- [ ] Support key rotation with `current` + `previous` active key set.
- [ ] Ensure grace-window behavior is documented and tested.
- [ ] Ensure short TTL assumptions align with rotation rollout windows.

## Security and Auditability

- [ ] Verify no path conflates attestation evidence with delegation authority.
- [ ] Verify attestations cannot trigger capability execution.
- [ ] Add logging for issuance decisions and verifier rejection reasons.
- [ ] Add metrics for issuance volume, verification failures, unknown `key_id`, and epoch rejects.

## Integration Rollout

- [ ] Add verifier integration to target services.
- [ ] Replace selected directory-based role checks with attestation verification.
- [ ] Preserve compatibility for services not yet migrated.
- [ ] Document migration plan for phased directory deprecation.

## Testing

- [ ] Unit tests: signature verification by `key_id`.
- [ ] Unit tests: subject/audience/subnet checks.
- [ ] Unit tests: TTL bounds and expiry rejection.
- [ ] Unit tests: epoch floor enforcement.
- [ ] Unit tests: unknown `key_id` refresh-once behavior.
- [ ] Unit tests: key rotation current+previous acceptance.
- [ ] Unit tests: fail-closed behavior on key fetch/verify failure.
- [ ] PocketIC test: issuance + verification happy path.
- [ ] PocketIC test: unauthorized/mismatched caller rejected.
- [ ] PocketIC test: expired attestation rejected.
- [ ] PocketIC test: audience mismatch rejected.
- [ ] PocketIC test: rotated key handling across grace period.

## Release Readiness

- [ ] `make fmt-check` passes.
- [ ] `make clippy` passes.
- [ ] `make test` passes.
- [ ] Security review sign-off captured.
- [ ] Final 0.12 design doc updated with implementation deltas.
