# 0.11 Status: Root Capabilities

Tracking checklist for implementing `docs/design/0.11-root-capabilities.md`.

## Metadata

- [ ] `Status owner assigned`
- [ ] `Target release confirmed as 0.11`
- [ ] `Implementation branch created`

## Core Architecture

- [ ] Add `RootCapability` enum (`Provision`, `Upgrade`, `MintCycles`, `IssueDelegation`).
- [ ] Add `RootCapabilityRequest` -> `RootCapability` mapping.
- [ ] Add `RootContext` extraction at root ingress.
- [ ] Add `execute_root_capability()` dispatcher in workflow layer.
- [ ] Ensure execution order is: context -> decode -> map -> authorize -> replay -> execute -> persist replay entry.

## Policy Layer

- [ ] Add per-capability policy functions.
- [ ] Move provisioning authorization checks into capability policy.
- [ ] Move delegation issuance authorization checks into capability policy.
- [ ] Ensure no capability uses broad implicit authorization.
- [ ] Ensure `IssueDelegation` requires explicit shard/caller binding.

## Replay and Idempotency

- [ ] Add `RootRequestMetadata { request_id, ttl_seconds }` for mutating capabilities.
- [ ] Enforce TTL using root local time (`IcOps::now_secs()`).
- [ ] Add max TTL bound enforcement.
- [ ] Add stable replay store for `request_id` + expiry.
- [ ] Add response cache or digest store for idempotent duplicate handling.
- [ ] Duplicate handling: identical payload returns cached response.
- [ ] Duplicate handling: different payload is rejected.

## Handler Integration

- [ ] Route provisioning handler through capability dispatcher.
- [ ] Route cycles mint handler through capability dispatcher.
- [ ] Route upgrade handler through capability dispatcher.
- [ ] Route delegation issuance handler through capability dispatcher.
- [ ] Keep signing logic isolated to existing delegation auth ops.

## Backward Compatibility

- [ ] Keep existing external root endpoints unchanged for 0.11.
- [ ] Convert old endpoints to thin adapters into capability dispatch.
- [ ] Preserve DTO wire compatibility in 0.11.
- [ ] Document any internal-only endpoint behavior changes.

## Security and Auditability

- [ ] Verify no generic "execute arbitrary root op" path exists.
- [ ] Verify no provisioning path can access signing primitives.
- [ ] Verify capability checks are centralized and auditable.
- [ ] Add logging at capability decision points (authorized/denied).
- [ ] Add metrics keyed by `RootCapability`.

## Testing

- [ ] Unit tests for request->capability mapping.
- [ ] Unit tests for per-capability authorization decisions.
- [ ] Unit tests for replay TTL expiration logic.
- [ ] Unit tests for duplicate idempotency semantics.
- [ ] PocketIC test: provisioning through capability dispatcher.
- [ ] PocketIC test: delegation issuance through capability dispatcher.
- [ ] PocketIC test: unauthorized caller denied per capability.
- [ ] PocketIC test: duplicate `request_id` identical payload returns cached response.
- [ ] PocketIC test: duplicate `request_id` different payload is rejected.

## Migration and Cleanup

- [ ] Phase 1 complete: dispatcher introduced behind adapters.
- [ ] Phase 2 complete: provisioning path migrated.
- [ ] Phase 3 complete: delegation path migrated.
- [ ] Phase 4 complete: legacy duplicate checks removed where safe.
- [ ] Update changelog with 0.11 capability framework progress.

## Release Readiness

- [ ] `make fmt-check` passes.
- [ ] `make clippy` passes.
- [ ] `make test` passes.
- [ ] Security review sign-off captured.
- [ ] Final 0.11 RFC/design doc updated with implementation deltas.
