# 0.11 Status: Root Capabilities

Tracking checklist for implementing `docs/design/0.11-root-capabilities.md`.

## Metadata

- [ ] `Status owner assigned`
- [ ] `Target release confirmed as 0.11`
- [ ] `Implementation branch created`

## Core Architecture

- [ ] Add `RootCapability` enum (`Provision`, `Upgrade`, `MintCycles`, `IssueDelegation`).
- [ ] Add `RootCapabilityRequest` -> `RootCapability` mapping.
- [ ] Add `RootContext` extraction at root ingress.
- [ ] Add `execute_root_capability()` dispatcher in workflow layer.
- [ ] Ensure execution order is: context -> decode -> map -> authorize -> replay -> execute -> persist replay entry.
- [ ] Ensure dispatcher rejects unknown variants.
- [ ] Ensure dispatcher uses exact enum matching (no string/reflection dispatch).

## RootContext Integrity

- [ ] Ensure `caller` is derived from `ic::caller()`.
- [ ] Ensure `subnet_id` is derived from system state.
- [ ] Ensure `now` is derived from `IcOps::now_secs()`.

## Policy Layer

- [ ] Add per-capability policy functions.
- [ ] Move provisioning authorization checks into capability policy.
- [ ] Move delegation issuance authorization checks into capability policy.
- [ ] Ensure no capability uses broad implicit authorization.
- [ ] Ensure `IssueDelegation` requires explicit shard/caller binding.

## Replay and Idempotency

- [ ] Add `RootRequestMetadata { request_id, ttl_seconds }` for mutating capabilities.
- [ ] Enforce TTL using root local time (`IcOps::now_secs()`).
- [ ] Add max TTL bound enforcement (`MAX_ROOT_TTL_SECONDS`).
- [ ] Require collision-resistant `request_id` generation.
- [ ] Add stable replay store for replay key, payload hash, response, and expiry.
- [ ] Ensure replay key includes capability variant, payload hash, caller, subnet, and `request_id`.
- [ ] Use Candid canonical encoding for payload hash.
- [ ] Ensure hash includes variant discriminant.
- [ ] Ensure hash excludes metadata when metadata is out-of-payload.
- [ ] Reject conflicting replay (`request_id` tuple reused with different payload hash).
- [ ] Ensure conflicting replay does not overwrite existing replay state.
- [ ] Ensure identical replay returns cached response.
- [ ] Check expiration before handler execution.
- [ ] Ensure expired entries are not resurrected/reinserted.
- [ ] Purge expired entries and enforce bounded replay map size.
- [ ] Ensure eviction prioritizes expired entries.

## Delegation Replay Determinism

- [ ] Ensure replay of `IssueDelegation` returns identical token material.
- [ ] Ensure duplicate accepted delegation requests do not mint new token material.

## Handler Integration

- [ ] Route provisioning handler through capability dispatcher.
- [ ] Route cycles mint handler through capability dispatcher.
- [ ] Route upgrade handler through capability dispatcher.
- [ ] Route delegation issuance handler through capability dispatcher.
- [ ] Keep signing logic isolated to existing delegation auth ops.

## Backward Compatibility

- [ ] Keep existing external root endpoints unchanged for 0.11.
- [ ] Convert old endpoints to thin adapters into capability dispatch.
- [ ] Preserve DTO wire compatibility in 0.11.
- [ ] Document any internal-only endpoint behavior changes.

## Security and Auditability

- [ ] Verify no generic "execute arbitrary root op" path exists.
- [ ] Verify no provisioning path can access signing primitives.
- [ ] Verify capability checks are centralized and auditable.
- [ ] Add logging at capability decision points (authorized/denied).
- [ ] Add metrics keyed by `RootCapability`.

## Testing

- [ ] Unit tests for request->capability mapping.
- [ ] Unit tests for per-capability authorization decisions.
- [ ] Unit tests for canonical replay key generation.
- [ ] Unit tests for replay TTL expiration logic.
- [ ] Unit tests for duplicate idempotency semantics.
- [ ] Unit tests for conflicting replay rejection semantics.
- [ ] Unit tests for eviction and bounded replay map behavior.
- [ ] PocketIC test: provisioning through capability dispatcher.
- [ ] PocketIC test: delegation issuance through capability dispatcher.
- [ ] PocketIC test: unauthorized caller denied per capability.
- [ ] PocketIC test: duplicate replay returns identical response.
- [ ] PocketIC test: duplicate `IssueDelegation` does not mint new token material.
- [ ] PocketIC test: conflicting replay is rejected.

## Migration and Cleanup

- [ ] Phase 1 complete: dispatcher introduced behind adapters.
- [ ] Phase 2 complete: provisioning/upgrade/cycle paths migrated.
- [ ] Phase 3 complete: delegation path migrated.
- [ ] Phase 4 complete: legacy duplicate checks removed where safe.
- [ ] Update changelog with 0.11 capability framework progress.

## Release Readiness

- [ ] `make fmt-check` passes.
- [ ] `make clippy` passes.
- [ ] `make test` passes.
- [ ] Security review sign-off captured.
- [ ] Final 0.11 design doc updated with implementation deltas.
