# 0.11 Status: Root Capabilities

Tracking checklist for implementing `docs/design/0.11-root-capabilities.md`.

## Metadata

- [ ] `Status owner assigned`
- [ ] `Target release confirmed as 0.11`
- [ ] `Implementation branch created`

## Core Architecture

- [x] Add `RootCapability` enum (`Provision`, `Upgrade`, `MintCycles`, `IssueDelegation`).
- [x] Add `RootCapabilityRequest` -> `RootCapability` mapping.
- [x] Add `RootContext` extraction at root ingress.
- [x] Add `execute_root_capability()` dispatcher in workflow layer.
- [x] Ensure execution order is: context -> decode -> map -> authorize -> replay -> execute -> persist replay entry.
- [x] Ensure dispatcher rejects unknown variants.
- [x] Ensure dispatcher uses exact enum matching (no string/reflection dispatch).

## RootContext Integrity

- [x] Ensure `caller` is derived from `ic::caller()`.
- [x] Ensure `subnet_id` is derived from system state.
- [x] Ensure `now` is derived from `IcOps::now_secs()`.

## Policy Layer

- [x] Add per-capability policy functions.
- [x] Move provisioning authorization checks into capability policy.
- [x] Move delegation issuance authorization checks into capability policy.
- [x] Ensure no capability uses broad implicit authorization.
- [x] Ensure `IssueDelegation` requires explicit shard/caller binding.

## Replay and Idempotency

- [x] Add `RootRequestMetadata { request_id, ttl_seconds }` for mutating capabilities.
- [x] Enforce TTL using root local time (`IcOps::now_secs()`).
- [x] Add max TTL bound enforcement (`MAX_ROOT_TTL_SECONDS`).
- [x] Require collision-resistant `request_id` generation.
- [x] Add stable replay store for replay key, payload hash, response, and expiry.
- [x] Ensure replay slot key is scoped by `(caller, subnet, request_id)`.
- [x] Ensure replay conflict digest binds canonical capability envelope bytes (includes variant discriminant, excludes metadata).
- [x] Ensure existing replay slot semantics are exact: `digest match -> cached`, `digest mismatch -> conflict`.
- [x] Use Candid canonical encoding for payload hash.
- [x] Ensure hash includes variant discriminant.
- [x] Ensure hash excludes metadata when metadata is out-of-payload.
- [x] Reject conflicting replay (`request_id` tuple reused with different payload hash).
- [x] Ensure conflicting replay does not overwrite existing replay state.
- [x] Ensure identical replay returns cached response.
- [x] Check expiration before handler execution.
- [x] Ensure expired entries are not resurrected/reinserted.
- [x] Purge expired entries and enforce bounded replay map size.
- [x] Ensure eviction prioritizes expired entries.

## Delegation Replay Determinism

- [x] Ensure replay of `IssueDelegation` returns identical token material.
- [x] Ensure duplicate accepted delegation requests do not mint new token material.

## Handler Integration

- [x] Route provisioning handler through capability dispatcher.
- [x] Route cycles mint handler through capability dispatcher.
- [x] Route upgrade handler through capability dispatcher.
- [x] Route delegation issuance handler through capability dispatcher.
- [x] Keep signing logic isolated to existing delegation auth ops.

## Backward Compatibility

- [x] Keep existing external root endpoints unchanged for 0.11.
- [x] Convert old endpoints to thin adapters into capability dispatch.
- [x] Preserve DTO wire compatibility in 0.11.
- [x] Document internal-only endpoint behavior changes (`canic_delegation_provision` removed; canonical `canic_request_delegation` remains).

## Security and Auditability

- [x] Verify no generic "execute arbitrary root op" path exists.
- [x] Verify no provisioning path can access signing primitives.
- [x] Verify capability checks are centralized and auditable.
- [x] Add logging at capability decision points (authorized/denied).
- [x] Add metrics keyed by `RootCapability`.

## Testing

- [x] Unit tests for request->capability mapping.
- [x] Unit tests for per-capability authorization decisions.
- [x] Unit tests for canonical replay key generation.
- [x] Unit tests for replay TTL expiration logic.
- [x] Unit tests for duplicate idempotency semantics.
- [x] Unit tests for conflicting replay rejection semantics.
- [x] Unit tests for eviction and bounded replay map behavior.
- [x] PocketIC test: provisioning through capability dispatcher.
- [x] PocketIC test: delegation issuance through capability dispatcher.
- [x] PocketIC test: unauthorized caller denied per capability.
- [x] PocketIC test: duplicate replay returns identical response.
- [x] PocketIC test: duplicate `IssueDelegation` does not mint new token material.
- [x] PocketIC test: conflicting replay is rejected.
- [x] Root replay tests default to skip delegation non-skip assertions when threshold keys are unavailable.
- [x] Root replay tests fail fast when `CANIC_REQUIRE_THRESHOLD_KEYS=1` and threshold keys are unavailable.
- [x] CI `checks` job pins `CANIC_REQUIRE_THRESHOLD_KEYS=0` for non-flaky default replay coverage.
- [x] CI `delegated-crypto` strict job pins `CANIC_REQUIRE_THRESHOLD_KEYS=1` and runs the non-skip delegation replay test path.

## Migration and Cleanup

- [x] Phase 1 complete: dispatcher introduced behind adapters.
- [x] Phase 2 complete: provisioning/upgrade/cycle paths migrated.
- [x] Phase 3 complete: delegation path migrated.
- [x] Phase 4 complete: legacy duplicate checks removed where safe.
- [x] Update changelog with 0.11 capability framework progress.

## Release Readiness

- [x] `make fmt-check` passes.
- [x] `make clippy` passes.
- [x] `make test` passes.
- [ ] Security review sign-off captured.
- [x] Final 0.11 design doc updated with implementation deltas.
