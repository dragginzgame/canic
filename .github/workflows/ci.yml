name: CI

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:

jobs:
  checks:
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      CANIC_REQUIRE_THRESHOLD_KEYS: "0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.92.0
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install fmt tools
        run: cargo install cargo-sort cargo-sort-derives --locked
      - name: Install wasm target
        run: rustup target add wasm32-unknown-unknown
      - name: Cache PocketIC server
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/pocket-ic-server-11.0.0
          key: pocket-ic-11.0.0-${{ runner.os }}
      - name: Install PocketIC server
        shell: bash
        run: |
          set -euxo pipefail
          VERSION="11.0.0"
          DIR="$RUNNER_TEMP/pocket-ic-server-$VERSION"
          BIN="$DIR/pocket-ic"
          mkdir -p "$DIR"

          if [ ! -x "$BIN" ]; then
            curl -L \
              -o "$BIN.gz" \
              "https://github.com/dfinity/pocketic/releases/download/$VERSION/pocket-ic-x86_64-linux.gz"
            gunzip -f "$BIN.gz"
            chmod +x "$BIN"
          fi

          echo "POCKET_IC_BIN=$BIN" >> "$GITHUB_ENV"
      - name: Build canister wasm artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .dfx/local/canisters

          for canister in app blank scale scale_hub shard shard_hub test user_hub user_shard; do
            cargo build --target wasm32-unknown-unknown -p "canister_${canister}" --locked
            mkdir -p ".dfx/local/canisters/${canister}"
            cp "target/wasm32-unknown-unknown/debug/canister_${canister}.wasm" ".dfx/local/canisters/${canister}/${canister}.wasm"
            gzip -n -c ".dfx/local/canisters/${canister}/${canister}.wasm" > ".dfx/local/canisters/${canister}/${canister}.wasm.gz"
          done

          cargo build --target wasm32-unknown-unknown -p canister_root --locked
          mkdir -p .dfx/local/canisters/root
          cp target/wasm32-unknown-unknown/debug/canister_root.wasm .dfx/local/canisters/root/root.wasm
          gzip -n -c .dfx/local/canisters/root/root.wasm > .dfx/local/canisters/root/root.wasm.gz
      - name: Layering guards
        shell: bash
        run: |
          set -euo pipefail
          if rg "storage::stable::.*Record" crates/canic-core/src/workflow; then
            echo "workflow must not touch storage records"
            exit 1
          fi

          if rg "pub use .*Record" crates/canic-core/src | rg -v "pub\\(crate\\)"; then
            echo "record types must not be publicly re-exported"
            exit 1
          fi

          if rg "(to_view|from_view)" crates/canic-core/src | rg -v "record_to_view|view::"; then
            echo "misuse of 'view' detected in function names"
            exit 1
          fi
      - name: Forbidden crypto API guards
        shell: bash
        run: |
          set -euo pipefail
          if rg -n "sign_with_ecdsa|verify_ecdsa|ecdsa_public_key" crates; then
            echo "forbidden ECDSA API detected"
            exit 1
          fi
      - run: make fmt-check
      - run: make clippy
      - run: cargo test --workspace --all-targets --verbose --locked -- --test-threads=1
      - name: Build examples (default)
        run: cargo build -p canic --examples --locked
      - name: Build examples (ic feature)
        run: cargo build -p canic --examples --features ic --locked

  delegated-crypto:
    if: (github.event_name == 'pull_request' || github.ref == 'refs/heads/main') && vars.CANIC_REQUIRE_THRESHOLD_KEYS == '1'
    runs-on: ubuntu-latest
    env:
      CANIC_REQUIRE_THRESHOLD_KEYS: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@v2
      - name: Install wasm target
        run: rustup target add wasm32-unknown-unknown
      - name: Cache PocketIC server
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/pocket-ic-server-12.0.0
          key: pocket-ic-12.0.0-${{ runner.os }}
      - name: Install PocketIC server
        shell: bash
        run: |
          set -euxo pipefail
          VERSION="12.0.0"
          DIR="$RUNNER_TEMP/pocket-ic-server-$VERSION"
          BIN="$DIR/pocket-ic"
          mkdir -p "$DIR"

          if [ ! -x "$BIN" ]; then
            curl -L \
              -o "$BIN.gz" \
              "https://github.com/dfinity/pocketic/releases/download/$VERSION/pocket-ic-x86_64-linux.gz"
            gunzip -f "$BIN.gz"
            chmod +x "$BIN"
          fi

          echo "POCKET_IC_BIN=$BIN" >> "$GITHUB_ENV"
      - name: Run strict root replay delegation non-skip test
        run: cargo test -p canic --test root_replay --locked delegation_issuance_routes_through_dispatcher_non_skip_path -- --nocapture --test-threads=1

  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.92.0
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install fmt tools
        run: cargo install cargo-sort cargo-sort-derives --locked
      - name: Install wasm target
        run: rustup target add wasm32-unknown-unknown
      - name: Cache PocketIC server
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/pocket-ic-server-11.0.0
          key: pocket-ic-11.0.0-${{ runner.os }}
      - name: Install PocketIC server
        shell: bash
        run: |
          set -euxo pipefail
          VERSION="11.0.0"
          DIR="$RUNNER_TEMP/pocket-ic-server-$VERSION"
          BIN="$DIR/pocket-ic"
          mkdir -p "$DIR"

          if [ ! -x "$BIN" ]; then
            curl -L \
              -o "$BIN.gz" \
              "https://github.com/dfinity/pocketic/releases/download/$VERSION/pocket-ic-x86_64-linux.gz"
            gunzip -f "$BIN.gz"
            chmod +x "$BIN"
          fi

          echo "POCKET_IC_BIN=$BIN" >> "$GITHUB_ENV"
      - name: Build canister wasm artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .dfx/local/canisters

          for canister in app blank scale scale_hub shard shard_hub test user_hub user_shard; do
            cargo build --target wasm32-unknown-unknown -p "canister_${canister}" --locked
            mkdir -p ".dfx/local/canisters/${canister}"
            cp "target/wasm32-unknown-unknown/debug/canister_${canister}.wasm" ".dfx/local/canisters/${canister}/${canister}.wasm"
            gzip -n -c ".dfx/local/canisters/${canister}/${canister}.wasm" > ".dfx/local/canisters/${canister}/${canister}.wasm.gz"
          done

          cargo build --target wasm32-unknown-unknown -p canister_root --locked
          mkdir -p .dfx/local/canisters/root
          cp target/wasm32-unknown-unknown/debug/canister_root.wasm .dfx/local/canisters/root/root.wasm
          gzip -n -c .dfx/local/canisters/root/root.wasm > .dfx/local/canisters/root/root.wasm.gz
      - name: Forbidden crypto API guards
        shell: bash
        run: |
          set -euo pipefail
          if rg -n "sign_with_ecdsa|verify_ecdsa|ecdsa_public_key" crates; then
            echo "forbidden ECDSA API detected"
            exit 1
          fi
      - run: make fmt-check
      - run: make clippy
      - run: cargo test --workspace --all-targets --verbose --locked -- --test-threads=1
      - run: cargo build --release --workspace --locked
