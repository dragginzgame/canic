#!/usr/bin/env bash
set -euo pipefail

# Skip if no staged Rust or Cargo files
if ! git diff --cached --name-only --diff-filter=ACM | grep -E '\\.rs$|^Cargo\\.toml$|^Cargo\\.lock$' -q; then
  exit 0
fi

# Auto-format before checks
cargo fmt --all

# Stage any formatting changes so they are included in the commit
if ! git diff --quiet; then
  echo "Formatting changed files; staging tracked updates..."
  git add -u
fi

# Run checks
cargo fmt --all -- --check
cargo sort --check
cargo sort-derives --check

echo "Pre-commit checks passed."